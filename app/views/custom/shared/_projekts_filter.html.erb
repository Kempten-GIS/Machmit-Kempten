<% projekts.each do |projekt| %>

  <% projekt_has_any_children_to_show = projekt.all_children_projekts.any? { |projekt| projekt.show_in_sidebar_filter?(params[:controller]) } %>


  <% if projekt.show_in_sidebar_filter?(params[:controller]) || projekt_has_any_children_to_show %>

    <% label_class =  ( @selected_projekts_ids && projekt.id.to_s.in?(@selected_projekts_ids) ) ? 'label-selected' : 'label_regular' %>
    <% checkbox_checked = @selected_projekts_ids && projekt.id.to_s.in?(@selected_projekts_ids)  %>
    <% projekt_color = projekt&.map_location&.pin_color.present? ? projekt&.map_location&.pin_color : nil %>

    <ul>
      <li class=''>
        <%= label_tag dom_id(projekt), class: label_class do %>
          <%= check_box_tag dom_id(projekt), projekt.id, checkbox_checked, { class: 'js-filter-projekt' }  %>
          <%= projekt.name %>
          <span class="checkmark"></span>
          <span class="color-code" <%= "style=background-color: #{projekt_color}" if projekt_color.present? %> ></span>
        <% end %>

        <% if projekt_has_any_children_to_show %>
          <span class='js-icon-toggle-child-projekts toggle-arrow'></span>
        <% end %>
      </li>

      <% if projekt_has_any_children_to_show %>
        <%= render partial: "shared/projekts_filter", locals: { projekts: projekt.children.with_order_number.select{ |projekt| projekt.show_in_sidebar_filter?(params[:controller]) } } %>
      <% end %>

    </ul>
  <% end %>

<% end %>
